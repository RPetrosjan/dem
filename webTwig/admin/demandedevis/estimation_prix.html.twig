{% set form = field_description.options.attr.form %}



{% form_theme form 'admin/demandedevis/form/fields.html.twig' %}

{#
{% form_theme form '@SonataAdmin/Form/form_admin_fields.html.twig' %}

{#
{% form_theme form 'admin/demandedevis/form/form_admin_fields.html.twig' %}
#}

{{ form_start(form) }}
   {{ form_widget(form) }}
{{ form_end(form) }}



<script type="text/javascript">


/*
    $(document).ready(function() {
        $("button[type=submit]").click(function(e) {   //bind handlers
            e.preventDefault();
        });

    });
*/
</script>

{% set elements = [] %}

{% for children in form.children %}
    {% for key, value in children.children  %}
        {% set elements = elements|merge([key]) %}
    {% endfor %}
{% endfor %}

<script>

    // GEt all elements d'un form Estimation Prix
    var devislements = {{ elements|json_encode()|raw }};



    function UpdatePriceShow() {
        var prixht = $("input[name*='prixht']").val();
        if($.isNumeric(prixht) == false) {
            prixht = 0;
        }
        var tva = $("input[name*='tva']").val();
        if($.isNumeric(tva) == false) {
            tva = 0;
        }

        var prixttc = parseFloat(prixht*tva / 100) + parseFloat(prixht);
        $("input[name*='prixttc']").val(prixttc);


        var accompte_commande = prixttc * $("input[name*='acompte']").val() / 100;
        if($.isNumeric(accompte_commande) == false) {
            accompte_commande = 0;
        }

        $("input[name*='acomptecommande']").val(accompte_commande);
        $("input[name*='soldelivraison']").val(prixttc - accompte_commande);
    }

    {% set url = path('devis_prev_doc_generator', {
        'uuid' : '2222',
        'type' :'devis',
        'json' : 'df'
    }) %}

    {%  set pdf_url = url[:url|strpos('2222')]  %}

    function MakeUrlPrevisualisation(jsonurl) {

        {% if admin.show.listdocs.options.attr.societecustom is not empty %}
        $('.devisPrev.js').html('' +
        {% for key, custom in admin.show.listdocs.options.attr.societecustom  %}
            '<a target="_blank" href="{{ pdf_url }}'+devisId+'/{{ key }}/'+encodeURI(jsonurl)+'"><i class="far fa-file-pdf"></i> {{ custom.Label }}</a>' +
        {#    <a target="_blank" href="{{ field_description.options.attr.url_devis}}{{ key }}"><i class="far fa-file-pdf"></i> {{ custom.Label }}</a> #}
        {% endfor %}
            '');
        {% else %}
            $('.devisPrev.js').html('' +
                '<a target="_blank" href="{{ pdf_url }}'+devisId+'/devis/'+encodeURI(jsonurl)+'"><i class="far fa-file-pdf"></i> Devis</a>' +
                '<a target="_blank" href="{{ pdf_url }}'+devisId+'/declaration_valeur/'+encodeURI(jsonurl)+'"><i class="far fa-file-pdf"></i> Declaration Valeur </a>' +
                '<a target="_blank" href="{{ pdf_url }}'+devisId+'/condition_generale/'+encodeURI(jsonurl)+'"><i class="far fa-file-pdf"></i> Condition Générale </a>' +
                '<a target="_blank" href="{{ pdf_url }}'+devisId+'/facture/'+encodeURI(jsonurl)+'"><i class="far fa-file-pdf"></i> Facture </a>' +
                '<a target="_blank" href="{{ pdf_url }}'+devisId+'/lettre_chargement/'+encodeURI(jsonurl)+'"><i class="far fa-file-pdf"></i> Lettre Chargement  </a>' +
                '<a target="_blank" href="{{ pdf_url }}'+devisId+'/lettre_dechargement/'+encodeURI(jsonurl)+'"><i class="far fa-file-pdf"></i> Lettre Dechargement  </a>' +
            '');

        {% endif %}



    }

    function getadvalorem() {
        var advalorem = [];
        $('div[id*=advalorem_]').each(function(){

            description = $(this).find("input.description").val();
            price       = $(this).find("input.prix").val();

            if(description.length>0 && price.length>0)
            {
                advalorem.push({
                    'description': $(this).find("input.description").val(),
                    'price'       : $(this).find("input.prix").val()
                });
            }
        })
///        console.log(JSON.stringify(advalorem));
        return advalorem;

    }

    function createElementsUrl(){
        var urlkey = {};
        devislements.forEach(function (elements) {

            if(elements != 'json') {
                if(elements == 'advalorem' ) {
                    urlkey[elements] = getadvalorem();
                }
                else {
                    urlkey[elements] = $("[name*= '"+elements+"']").val();
                }
            }
        });

        $(".hiddenjson").val(JSON.stringify(urlkey));
        MakeUrlPrevisualisation(JSON.stringify(urlkey))
    }


    // Convert in jqeurt command line
    var jquerytext = '';
    devislements.forEach(function (elements) {
        jquerytext += "[name*='"+elements+"'], ";
    });
    // Remove 2 last character
    jquerytext = jquerytext.substr(0,jquerytext.length-2);
    // Activated all elements for jquery command keyup
    function InitialisePriceUpdate()
    {
        $(jquerytext).unbind('keyup').unbind('change').on('keyup change', function () {
            // Calcul price
            // Pas besoin reagir dans textArea  Coment
            if($(this).attr('id').toLowerCase().indexOf('commentsociete') == -1) {
                UpdatePriceShow();
                createElementsUrl();
            }
        });
    }
    InitialisePriceUpdate();

    function InitializeCollectionDelete() {
        $('.sonata-collection-delete').unbind('click').click(function () {
            setTimeout(function () {
                InitialisePriceUpdate();
                InitialisePrixTTC();
                calculPrixTTC();
                createElementsUrl();
            }, 1000);
          console.log('delete');
        })
    }


    $('.sonata-collection-add').unbind('click').click(function () {
        setTimeout(function () {
            InitialisePriceUpdate();
            InitialisePrixTTC();
            InitializeCollectionDelete();
        }, 1000);
    })

    function calculPrixTTC(){
        $prixttc = 0;
        $('input.prix').each(function(){
            if($(this).val().length>0 && $.isNumeric($(this).val())) {
                $prixttc += parseFloat($(this).val());
            }
        });
        $("input[name*= 'prixht']").val($prixttc);
    }

    function InitialisePrixTTC() {
        $(':input.prix').keyup(function(){
            calculPrixTTC();
        })
    }

    calculPrixTTC();
    InitialisePrixTTC();


</script>